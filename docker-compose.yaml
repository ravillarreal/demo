services:
  db:
    image: postgres:16-alpine
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
      - POSTGRES_MULTIPLE_DATABASES=zitadel,openfga
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    ports:
      - "5432:5432"
    volumes:
      - ./postgres-init:/docker-entrypoint-initdb.d:ro,z
      - db-data:/var/lib/postgresql/data

  # ZITADEL - Identidad B2B
  zitadel:
    image: ghcr.io/zitadel/zitadel:latest
    command: ["start-from-init", "--masterkeyFromEnv"]
    environment:
      - ZITADEL_MASTERKEY=MasterkeyNeedsToHave32Characters
      - ZITADEL_DATABASE_POSTGRES_DSN=postgres://postgres:password@db:5432/zitadel?sslmode=disable
      - ZITADEL_TLS_ENABLED=false
      - ZITADEL_EXTERNALSECURE=false
      - ZITADEL_DATABASE_POSTGRES_HOST=db
      - ZITADEL_DATABASE_POSTGRES_USER=postgres
      - ZITADEL_DATABASE_POSTGRES_PASSWORD=password
      - ZITADEL_DATABASE_POSTGRES_DATABASE=zitadel
      - ZITADEL_DATABASE_POSTGRES_SSL_MODE=disable
      # Admin credentials (used by init/setup jobs)
      - ZITADEL_DATABASE_POSTGRES_ADMIN_USERNAME=postgres
      - ZITADEL_DATABASE_POSTGRES_ADMIN_PASSWORD=password
      - ZITADEL_DATABASE_POSTGRES_ADMIN_SSL_MODE=disable
      # Application user credentials (ZITADEL will use these to connect)
      - ZITADEL_DATABASE_POSTGRES_USER_USERNAME=postgres
      - ZITADEL_DATABASE_POSTGRES_USER_PASSWORD=password
      - ZITADEL_DATABASE_POSTGRES_USER_SSL_MODE=disable
      - ZITADEL_DEFAULTINSTANCE_FEATURES_LOGINV2_REQUIRED=false
      - ZITADEL_EXTERNALDOMAIN=localhost
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "8080:8080"

  # OPENFGA - Autorización Fina
  openfga:
    image: openfga/openfga:latest
    command: run --playground-enabled=false --log-level debug
    environment:
      - OPENFGA_DATASTORE_ENGINE=postgres
      - OPENFGA_DATASTORE_URI=postgres://postgres:password@db:5432/openfga?sslmode=disable
      - OPENFGA_HTTP_ADDR=0.0.0.0:8081
      - OPENFGA_GRPC_ADDR=0.0.0.0:8082 # Movemos gRPC a otro puerto interno
      - OPENFGA_HTTP_TLS_ENABLED=true
      - OPENFGA_HTTP_TLS_CERT=/certs/openfga.crt
      - OPENFGA_HTTP_TLS_KEY=/certs/openfga.key
      # --- AUTENTICACIÓN OIDC ---
      - OPENFGA_AUTHN_METHOD=oidc
      - OPENFGA_AUTHN_OIDC_ISSUER=http://localhost:8080
      - OPENFGA_AUTHN_OIDC_AUDIENCE=${APISIX_OIDC_CLIENT_ID}
      - OPENFGA_BOOTSTRAP_TIMEOUT=0
      - OPENFGA_LOG_LEVEL=debug
      - OPENFGA_LOG_FORMAT=text
      - OPENFGA_AUTHN_OIDC_CLIENT_ID_CLAIMS="client_id"
    volumes:
      - ./certs:/certs:ro,z
    extra_hosts:
      - "localhost:host-gateway"
    ports:
      - "8081:8081" # REST API
      - "8082:8082" # gRPC API
    depends_on:
      db:
        condition: service_healthy

  # openfga-migrate:
  #   image: openfga/openfga:latest
  #   command: migrate
  #   environment:
  #     - OPENFGA_DATASTORE_ENGINE=postgres
  #     - OPENFGA_DATASTORE_URI=postgres://postgres:password@db:5432/openfga?sslmode=disable
  #   depends_on:
  #     db:
  #       condition: service_healthy
  #   restart: "no"
  # APISIX - Gateway
  apisix:
    image: apache/apisix:3.14.1-debian
    volumes:
      - ./apisix_conf/config.yaml:/usr/local/apisix/conf/config.yaml:ro,z
      - ./apisix_conf/apisix.yaml:/usr/local/apisix/conf/apisix.yaml:ro,z
      - ./apisix_conf/plugins/authz-openfga.lua:/usr/local/apisix/apisix/plugins/authz-openfga.lua:ro,z
      - ./certs:/certs:ro,z
    environment:
      - APISIX_DEPLOYMENT_MODE=standalone
      - APISIX_CLIENT_CERT=${APISIX_CLIENT_CERT}
      - APISIX_CLIENT_KEY=${APISIX_CLIENT_KEY}
      - APISIX_OIDC_CLIENT_ID=${APISIX_OIDC_CLIENT_ID}
      - APISIX_OIDC_CLIENT_SECRET=${APISIX_OIDC_CLIENT_SECRET}
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
    extra_hosts:
      - "localhost:host-gateway"
    ports:
      - "9080:9080" # Tráfico HTTP
      - "9180:9180" # Admin API (opcional en modo standalone) 
    depends_on:
      - service_a
      - service_b
      - openfga
      - zitadel

  # TU APP EN GO (Servidor gRPC)
  service_a:
    build: ./service_a
    volumes:
      - ./certs:/certs:ro,z
    ports:
      - "50051:50051"

  service_b:
    build: ./service_b
    ports:
      - "50052:50052"
    volumes:
      - ./certs:/certs:ro,z
    depends_on:
      - service_a

volumes:
  db-data: