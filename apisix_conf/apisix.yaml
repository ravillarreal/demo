plugin_configs:
  - id: 1
    plugins:
      openid-connect:
        client_id: "356002209726529540"
        client_secret: "${{APISIX_OIDC_CLIENT_SECRET}}"
        discovery: "http://localhost:8080/.well-known/openid-configuration"
        bearer_only: true
        set_userinfo_header: true
      authz-openfga:
        host: "https://openfga:8081"
        store_id: 01KF7N5ZQNE364EYZJNJCN8SKK
        authorization_model_id: "01KF7N602QM1KBNEQJ549TQAC3"
        client_cert: "${{APISIX_CLIENT_CERT}}"
        client_key: "${{APISIX_CLIENT_KEY}}"
        ssl_verify: true
        check:
          condition: AND
          tuples:
            - user_id: claim::sub
              user_type: user
              relation: member
              object_type: tenant
              object_id: "$http_x_tenant_id"
      grpc-transcode:
        proto_id: "user_proto"
        service: "user.v1.UserService"
        method: "GetUserInfo"



routes:
  - uri: /api/v1/*
    name: "zitadel-openfga-route"
    methods: ["GET", "POST"]
    plugin_config_id: 1
    upstream:
      type: roundrobin
      scheme: grpcs
      nodes:
        "service_b:50052": 1
      tls:
        client_cert: "${{APISIX_CLIENT_CERT}}"
        client_key: "${{APISIX_CLIENT_KEY}}"
        verify: false

protos:
  - id: "user_proto"
    content: |
      syntax = "proto3";
      package user.v1;
      service UserService {
        rpc GetUserInfo (UserRequest) returns (UserResponse);
      }
      message UserRequest { string id = 1; }
      message UserResponse { string message = 2; string tenant_id = 3; }

#END