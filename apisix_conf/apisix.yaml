consumers:
  - username: zitadel_user
    plugins:
      jwt-auth:
        key: "http://localhost:8080"
        algorithm: RS256
        public_key: |
          -----BEGIN PUBLIC KEY-----
          MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA3+nsh/bkOlcIhzdmyOvG
          0MNfVU2O0zb3WN/nscGZ8K1mNd1s/m2+mudK43pLUDLDpSrjLcO540Jgw0JfsaeQ
          564HFOn/gQp4NKEqhhN0M4eb61l32LvxXFdVTp4lBlazukBiVzyKTVZ9NcUCKsbx
          UviCW8osVCkIiRuc+oM1bgVEYYzC64FxxXEYvZM+/8fP28toufmsycX4hZLCdrhC
          7ldybwaPQVri+5VR/J/PNNxj7VsFmHdCuD8VP6Li9/rKZLJ9QonU6NPCIlk5nLRP
          3vfgTD6HwkjF4J5LniQev1DmPVtVzP+gy3qVkF9rYmX9sHA3h2ZJfxzUgDyXkORA
          3wIDAQAB
          -----END PUBLIC KEY-----

routes:
  - uri: /hello
    name: "zitadel-openfga-route"
    methods: ["GET", "POST"]
    plugins:
      jwt-auth:
        key_claim_name: iss
      authz-openfga:
        host: "http://openfga:8081"
        store_id: 01KEBJWCRJ97CX2BB6KR0BMWXN
        authorization_model_id: "01KEBJWD6AWXDHB1W4GKPDT1HQ"
        check:
          condition: AND
          tuples:
            - user_id: claim::sub
              relation: member
              object_type: tenant
              object_id: "$http_x_tenant_id"
      grpc-transcode:
        proto_id: "user_proto"
        service: "user.UserService"
        method: "GetUserInfo"
      proxy-rewrite:
        headers:
          set:
            X-User-ID: "$context.auth_claim.sub"
            Authorization: "$http_authorization"

    upstream:
      type: roundrobin
      scheme: grpc
      nodes:
        "go-app:50051": 1
      tls:
        client_cert: "${{APISIX_CLIENT_CERT}}"
        client_key: "${{APISIX_CLIENT_KEY}}"

protos:
  - id: "user_proto"
    content: |
      syntax = "proto3";
      package user;
      service UserService {
        rpc GetUserInfo (UserRequest) returns (UserResponse);
      }
      message UserRequest { string id = 1; }
      message UserResponse { string message = 2; string tenant_id = 3; }

#END